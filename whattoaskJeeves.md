I am trying to create a combat simulator to do a mathematical analysis on the mobile game FGO or Fate Grand Order, I have all the characters stats and skills and noble phantasms in a mongodb database and all the difficult quest saved. I am having difficulty implementing skills and noblephantasms that have conditional effects. In the json data the skill or noblephantasm is considered to have a conditional effect when it has a non empty entry for "functvals" or "script" or "funcquestTvals". When "functvals" is nonempty it means that the target in "funcTargetType" will only receive the effect if they contain that trait in their traits list. 



Koyanskaya NP effect applied after damage:
"functions":[{"funcId":1608,"funcType":"addStateShort","funcTargetType":"enemyAll","funcTargetTeam":"playerAndEnemy","functvals":[],"overWriteTvalsList":[],"funcquestTvals":[],"script":{},"funcGroup":[],"buffs":[{"id":506,"name":"BusterCardResistDown","type":"downDefencecommandall","buffGroup":0,"script":{},"originalScript":{},"vals":[{"id":3005,"name":"buffNegativeEffect"},{"id":3009,"name":"buffDecreaseDefence"}],"tvals":[{"id":5000,"name":"canBeInBattle"},{"id":4002,"name":"cardBuster"}],"ckSelfIndv":[],"ckOpIndv":[{"id":4002,"name":"cardBuster"}],"maxRate":5000}],"svals":[{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200}],"svals2":[{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200}],"svals3":[{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200}],"svals4":[{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200}],"svals5":[{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200}]}]

arjuna alter NP effect applied before damage:
"functions":[{"funcId":1609,"funcType":"addStateShort","funcTargetType":"enemyAll","funcTargetTeam":"playerAndEnemy","functvals":[],"overWriteTvalsList":[],"funcquestTvals":[],"script":{},"funcGroup":[],"buffs":[{"id":506,"name":"BusterCardResistDown","type":"downDefencecommandall","buffGroup":0,"script":{},"originalScript":{},"vals":[{"id":3005,"name":"buffNegativeEffect"},{"id":3009,"name":"buffDecreaseDefence"}],"tvals":[{"id":5000,"name":"canBeInBattle"},{"id":4002,"name":"cardBuster"}],"ckSelfIndv":[],"ckOpIndv":[{"id":4002,"name":"cardBuster"}],"maxRate":5000}],"svals":[{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200},{"Rate":1000,"Turn":3,"Count":-1,"Value":200}],"svals2":[{"Rate":1000,"Turn":3,"Count":-1,"Value":300},{"Rate":1000,"Turn":3,"Count":-1,"Value":300},{"Rate":1000,"Turn":3,"Count":-1,"Value":300},{"Rate":1000,"Turn":3,"Count":-1,"Value":300},{"Rate":1000,"Turn":3,"Count":-1,"Value":300}],"svals3":[{"Rate":1000,"Turn":3,"Count":-1,"Value":400},{"Rate":1000,"Turn":3,"Count":-1,"Value":400},{"Rate":1000,"Turn":3,"Count":-1,"Value":400},{"Rate":1000,"Turn":3,"Count":-1,"Value":400},{"Rate":1000,"Turn":3,"Count":-1,"Value":400}],"svals4":[{"Rate":1000,"Turn":3,"Count":-1,"Value":500},{"Rate":1000,"Turn":3,"Count":-1,"Value":500},{"Rate":1000,"Turn":3,"Count":-1,"Value":500},{"Rate":1000,"Turn":3,"Count":-1,"Value":500},{"Rate":1000,"Turn":3,"Count":-1,"Value":500}],"svals5":[{"Rate":1000,"Turn":3,"Count":-1,"Value":600},{"Rate":1000,"Turn":3,"Count":-1,"Value":600},{"Rate":1000,"Turn":3,"Count":-1,"Value":600},{"Rate":1000,"Turn":3,"Count":-1,"Value":600},{"Rate":1000,"Turn":3,"Count":-1,"Value":600}]},]

nemo NP effect applied before damage:
"functions":[{"funcId":248,"funcType":"addStateShort","funcTargetType":"self","funcTargetTeam":"playerAndEnemy","functvals":[],"overWriteTvalsList":[],"funcquestTvals":[],"script":{},"funcGroup":[],"buffs":[{"id":138,"name":"NPStrengthUp","type":"upNpdamage","buffGroup":0,"script":{"ProgressSelfTurn":1},"originalScript":{"ProgressSelfTurn":1},"vals":[{"id":3004,"name":"buffPositiveEffect"},{"id":3006,"name":"buffIncreaseDamage"},{"id":3030,"name":"buffNpDamageUp"}],"tvals":[],"ckSelfIndv":[],"ckOpIndv":[],"maxRate":5000}],"svals":[{"Rate":1000,"Turn":1,"Count":-1,"Value":100},{"Rate":1000,"Turn":1,"Count":-1,"Value":100},{"Rate":1000,"Turn":1,"Count":-1,"Value":100},{"Rate":1000,"Turn":1,"Count":-1,"Value":100},{"Rate":1000,"Turn":1,"Count":-1,"Value":100}],"svals2":[{"Rate":1000,"Turn":1,"Count":-1,"Value":150},{"Rate":1000,"Turn":1,"Count":-1,"Value":150},{"Rate":1000,"Turn":1,"Count":-1,"Value":150},{"Rate":1000,"Turn":1,"Count":-1,"Value":150},{"Rate":1000,"Turn":1,"Count":-1,"Value":150}],"svals3":[{"Rate":1000,"Turn":1,"Count":-1,"Value":200},{"Rate":1000,"Turn":1,"Count":-1,"Value":200},{"Rate":1000,"Turn":1,"Count":-1,"Value":200},{"Rate":1000,"Turn":1,"Count":-1,"Value":200},{"Rate":1000,"Turn":1,"Count":-1,"Value":200}],"svals4":[{"Rate":1000,"Turn":1,"Count":-1,"Value":250},{"Rate":1000,"Turn":1,"Count":-1,"Value":250},{"Rate":1000,"Turn":1,"Count":-1,"Value":250},{"Rate":1000,"Turn":1,"Count":-1,"Value":250},{"Rate":1000,"Turn":1,"Count":-1,"Value":250}],"svals5":[{"Rate":1000,"Turn":1,"Count":-1,"Value":300},{"Rate":1000,"Turn":1,"Count":-1,"Value":300},{"Rate":1000,"Turn":1,"Count":-1,"Value":300},{"Rate":1000,"Turn":1,"Count":-1,"Value":300},{"Rate":1000,"Turn":1,"Count":-1,"Value":300}]}]

nemo NP effect only applies if the current fieldtype is in "funcquestTvals" 
"functions":[{"funcId":6022,"funcType":"addStateShort","funcTargetType":"self","funcTargetTeam":"playerAndEnemy","functvals":[],"overWriteTvalsList":[],"funcquestTvals":[{"id":2039,"name":"fieldShore"},{"id":2730,"name":"fieldImaginarySpace"}],"script":{},"funcGroup":[],"buffs":[{"id":3052,"name":"NPStrengthUp","type":"upNpdamage","buffGroup":0,"script":{},"originalScript":{},"vals":[{"id":3004,"name":"buffPositiveEffect"},{"id":3006,"name":"buffIncreaseDamage"},{"id":3030,"name":"buffNpDamageUp"}],"tvals":[],"ckSelfIndv":[],"ckOpIndv":[],"maxRate":5000}],"svals":[{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1},{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1},{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1},{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1},{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1}],"svals2":[{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1},{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1},{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1},{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1},{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1}],"svals3":[{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1},{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1},{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1},{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1},{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1}],"svals4":[{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1},{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1},{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1},{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1},{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1}],"svals5":[{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1},{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1},{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1},{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1},{"Rate":1000,"Turn":1,"Count":-1,"Value":200,"ShowQuestNoEffect":1}]}]